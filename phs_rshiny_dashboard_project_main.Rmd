---
title: "phs_rshiny_dashboard_project_main"
output: html_notebook
---

# Packages
#--------------------------------------------------------------------------#
```{r, echo=FALSE, message=FALSE, results='hide'}
library(tidyverse)
library(janitor)
library(jsonlite)
library(lubridate)
```

# API Function
#--------------------------------------------------------------------------#

```{r, echo=FALSE, message=FALSE, results='hide'}
# Function for fetching phs dataframes
phs_df_func <- function(id){
  
  # Link templates for simplicity
  phs_url = "https://www.opendata.nhs.scot/api/3/action/datastore_search?resource_id="
  # fetch maximum 999'999 results for simplicity
  limit_url = "&limit=999999"
  
  # construct URL for fetching process
  url_link <- paste0(phs_url, id, limit_url) %>%
    fromJSON()
  
  # construct dataframe from url
  phs_df <-  url_link[["result"]][["records"]] %>% 
    clean_names()
  
  return(phs_df)

}


phs_dictionary_func <- function(id){
  
  # Link templates for simplicity
  phs_url = "https://www.opendata.nhs.scot/api/3/action/datastore_search?resource_id="
  # fetch maximum 999'999 results for simplicity
  limit_url = "&limit=10"
  
  # construct URL for fetching process
  url_link <- paste0(phs_url, id, limit_url) %>%
    fromJSON()
  
  # construct dataframe from url
  phs_dictionary <-  url_link[["result"]][["fields"]] %>% 
    jsonlite::flatten(recursive = TRUE) %>% 
    select(id, info.label, type)
  #    jsonlite::flatten(recursive = TRUE, use.names = TRUE)

  return(phs_dictionary)
}

```

# PHS API (ID)
#--------------------------------------------------------------------------#
```{r, echo=FALSE, message=FALSE, results='hide'}
# Hospital Activity (Data group 1)
# Dataset 1A - Hospital Activity by Speciality
ha_spe_api = "c3b4be64-5fb4-4a2f-af41-b0012f0a276a" 
# Dataset 1B - Hospital Activity and Patient Demographics
ha_ans_api = "00c00ecc-b533-426e-a433-42d79bdea5d4"
# Dataset 1C - Hospital Activity and Deprivation
ha_dep_api = "4fc640aa-bdd4-4fbe-805b-1da1c8ed6383"


# Hospitalisations due to Covid 19 (Data group 2)
# Dataset 2A - Admissions By Health Board and Specialty
cov_hb_spe_api = "b8aeb539-fcf8-4f66-aae8-20213508a1b7"
# Dataset 2B - Admissions By Health Board and Patient Demographics
cov_hb_ans_api = "f8f3a435-1925-4c5a-b2e8-e58fdacf04bb"
# Dataset 2C - Admissions By Health Board and Deprivation
cov_hb_dep_api = "746f9bac-77f1-43fe-b69f-5ca2cde2201b"

# Dataset 2D - Admissions By HSCP and Specialty
cov_hscp_spe_api =  "02696773-7aaf-48ce-b3d5-479d86fc8334"
# Dataset 2E - Admissions By HSCP and Patient Demographics
cov_hscp_ans_api = "aec5cc00-3ad6-41fb-9101-37c66bad29d4"
# Dataset 2F - Admissions By HSCP and Deprivation
cov_hscp_dep_api = "95a324b3-7610-4151-9287-ccd9cb191686"

# A&E attendances and performance data
ane_act_api = "2a4adc0a-e8e3-4605-9ade-61e13a85b3b9"

 
# Quarterly Hospital Beds Information - Datasets - Scottish Health and Social Care Open Data - nhs.scot
# Delayed discharge data
bed_info_api = "25bdc37b-4a77-4ff8-9b3a-edaba6e1c613"
bed_pubnote_api = "25bdc37b-4a77-4ff8-9b3a-edaba6e1c613"

# Location / ID Identifier
# Hospital List (Health Board)
health_board_api = "652ff726-e676-4a20-abda-435b98dd7bdc"
special_health_board_api = "0450a5a2-f600-4569-a9ae-5d6317141899"
hospital_location_api = "c698f450-eeed-41a0-88f7-c1e40a568acc"
# HSCP List 
hscp_api = "944765d7-d0d9-46a0-b377-abb3de51d08e"

```

# Load in API Dataframe (Backup)
#--------------------------------------------------------------------------#
```{r}

# Dataset 1A - Hospital Activity by Speciality
backup_ha_spe = phs_df_func(ha_spe_api)
# Dataset 1B - Hospital Activity and Patient Demographics
backup_ha_ans = phs_df_func(ha_ans_api)
# Dataset 1C - Hospital Activity and Deprivation
backup_ha_dep = phs_df_func(ha_dep_api)



# Hospitalisations due to Covid 19 (Data group 2)
# Dataset 2A - Admissions By Health Board and Specialty
backup_cov_hb_spe = phs_df_func(cov_hb_spe_api)
# Dataset 2B - Admissions By Health Board and Patient Demographics
backup_cov_hb_ans = phs_df_func(cov_hb_ans_api)
# Dataset 2C - Admissions By Health Board and Deprivation
backup_cov_hb_dep = phs_df_func(cov_hb_dep_api)

# Dataset 2D - Admissions By HSCP and Specialty
backup_cov_hscp_spe = phs_df_func(cov_hscp_spe_api)
# Dataset 2E - Admissions By HSCP and Patient Demographics
backup_cov_hscp_ans = phs_df_func(cov_hscp_ans_api)
# Dataset 2F - Admissions By HSCP and Deprivation
backup_cov_hscp_dep = phs_df_func(cov_hscp_dep_api)


backup_hospital_location = phs_df_func(hospital_location_api)
```


# Cleaning & Merging Dataset
#--------------------------------------------------------------------------#

## Data Group 00 - Hospital Location
```{r}
# Hospital Location
df_hospital_location <-  backup_hospital_location %>%
  select(-ends_with("qf"), -id) %>% 
  rename(long = x_coordinate,
         lat = y_coordinate)

# function to assign hospital name, longitude & latitude to dataframe
# hospital_location_func(datafram, "key column")
hospital_location_func <- function(df, key_col){
            df <- df %>% 
            # Select location & hb as forgein keys
            # Join location_name, longitude & latitude to the main dataframe
            left_join(df_hospital_location %>% select(key_col, location_name, long, lat),
            by = c(key_col),
            all.x = TRUE)
            
            return(df)
}


```

## Data Group 01 - Hospital Activity
```{r}
# clean_ha_df_func(dataframe)
clean_ha_df_func <- function(df){
                df <- df %>% 
                select(-ends_with("qf"), -id) %>% 
                mutate(year = substr(quarter, 1,4),
                quarter = substr(quarter,nchar(quarter), nchar(quarter))) %>% 
                # Relocate the year and quarter columns to the start
                relocate(c("year" ,"quarter"), .before = 1)
                # Return cleaned dataframe
                return(df)
}

# Dataset 1A - Hospital Activity by Speciality
df_ha_spe <- clean_ha_df_func(backup_ha_spe)
# Dataset 1B - Hospital Activity and Patient Demographics
df_ha_ans <- clean_ha_df_func(backup_ha_ans)
# Dataset 1C - Hospital Activity and Deprivation
df_ha_dep <- clean_ha_df_func(backup_ha_dep) 


```

## Data Group 02 - Hospitalisations due to Covid 19
```{r}
# Clean Hospitalisations Dataset function
clean_cov_df_func <- function(df){
                  df <- df %>% 
                  # Remove any columns ends with qf (Qualifier)
                  select(-ends_with("qf"), -id) %>% 
                  # Extract he quarter, year info from week_ending
                  mutate(week_ending = as.Date(ymd(week_ending)),
                         quarter     = quarter(week_ending),
                         year        = year(week_ending)) %>% 
                  # Relocate the year and quarter columns to the start
                  relocate(c("year" ,"quarter"), .before = 1)
                  # Return cleaned dataframe
                  return(df)
}

# Dataset 2A - Admissions By Health Board and Specialty
df_cov_hb_spe  <- clean_cov_df_func(backup_cov_hb_spe)
# Dataset 2B - Admissions By Health Board and Patient Demographics
df_cov_hb_ans <- clean_cov_df_func(backup_cov_hb_ans)
# Dataset 2C - Admissions By Health Board and Deprivation
df_cov_hb_dep <- clean_cov_df_func(backup_cov_hb_dep)
# Dataset 2D - Admissions By HSCP and Specialty
df_cov_hscp_spe <- clean_cov_df_func(backup_cov_hscp_spe)
# Dataset 2E - Admissions By HSCP and Patient Demographics
df_cov_hscp_ans <- clean_cov_df_func(backup_cov_hscp_ans)
# Dataset 2F - Admissions By HSCP and Deprivation
df_cov_hscp_dep <- clean_cov_df_func(backup_cov_hscp_dep)

```

# Extra Code that maybe useful
```{r}
# Join multiple location dataset with hospital location
# df_ha_dep <- backup_ha_dep %>% 
#   select(-ends_with("qf"), -id) %>% 
#   left_join(df_hospital_location %>% select(location, hb, location_name, long, lat),
#             by = c("location","hb"),
#             all.x = TRUE)


```









